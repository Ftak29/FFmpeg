name: build-ffmpeg-android-shared

on:
  workflow_dispatch:
    inputs:
      ffmpeg_repo:
        description: 'FFmpeg repo URL'
        required: false
        default: 'https://github.com/Ftak29/FFmpeg.git'
        type: string
      ffmpeg_ref:
        description: 'FFmpeg ref (branch/tag/commit)'
        required: false
        default: 'n6.1'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone FFmpeg (your fork)
        run: |
          rm -rf ffmpeg
          git clone --depth 1 --branch "${{ github.event.inputs.ffmpeg_ref }}" "${{ github.event.inputs.ffmpeg_repo }}" ffmpeg

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            yasm nasm pkg-config build-essential git \
            autoconf automake libtool cmake ninja-build

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Build FFmpeg (Android, multi-ABI, shared)
        run: |
          set -euo pipefail
          cd ffmpeg

          NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
          API=21
          TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64"
          SYSROOT="$TOOLCHAIN/sysroot"

          rm -rf out
          mkdir -p out

          build_one() {
            ABI="$1"
            CPU="$2"
            ARCH="$3"
            CC="$4"
            CXX="$5"

            PREFIX="$PWD/out/$ABI"
            mkdir -p "$PREFIX"

            echo "==== Building FFmpeg for $ABI ===="

            if [ -f Makefile ]; then
              make distclean || true
            fi

            EXTRA_CONFIG=()
            if [ "$ABI" = "x86" ]; then
              EXTRA_CONFIG+=(--disable-x86asm)
            fi

            ./configure \
              --prefix="$PREFIX" \
              --target-os=android \
              --arch="$ARCH" \
              --cpu="$CPU" \
              --enable-cross-compile \
              --sysroot="$SYSROOT" \
              --cc="$CC" \
              --cxx="$CXX" \
              --ar="$TOOLCHAIN/bin/llvm-ar" \
              --ranlib="$TOOLCHAIN/bin/llvm-ranlib" \
              --strip="$TOOLCHAIN/bin/llvm-strip" \
              --enable-shared --disable-static \
              --disable-doc --disable-programs \
              --enable-gpl --enable-version3 \
              --enable-protocol=http,https,tcp,udp,file,pipe,crypto \
              --enable-demuxer=hls,mpegts,matroska,mov,avi \
              --enable-decoder=h264,hevc,aac,mp3,ac3,eac3,opus,flac \
              --enable-decoder=mpeg2video,mpeg4,vp9,av1 \
              --enable-decoder=dvbsub,hdmv_pgs_subtitle,ass,subrip,mov_text,eia_608,eia_708 \
              --extra-cflags="" \
              "${EXTRA_CONFIG[@]}"

            make -j"$(nproc)"
            make install
          }

          build_one "arm64-v8a" "armv8-a" "aarch64" \
            "$TOOLCHAIN/bin/aarch64-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/aarch64-linux-android${API}-clang++"

          build_one "armeabi-v7a" "armv7-a" "arm" \
            "$TOOLCHAIN/bin/armv7a-linux-androideabi${API}-clang" \
            "$TOOLCHAIN/bin/armv7a-linux-androideabi${API}-clang++"

          build_one "x86_64" "x86-64" "x86_64" \
            "$TOOLCHAIN/bin/x86_64-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/x86_64-linux-android${API}-clang++"

          build_one "x86" "i686" "x86" \
            "$TOOLCHAIN/bin/i686-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/i686-linux-android${API}-clang++"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-android-shared
          path: ffmpeg/out
