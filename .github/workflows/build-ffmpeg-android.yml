name: build-ffmpeg-android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If FFmpeg is NOT the root of this repo, clone it:
      - name: Clone FFmpeg
        run: |
          rm -rf ffmpeg
          git clone --depth 1 --branch n6.1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            yasm nasm pkg-config build-essential git \
            autoconf automake libtool cmake ninja-build

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Build FFmpeg (Android, multi-ABI, static+PIC)
        run: |
          set -euo pipefail

          cd ffmpeg

          NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
          echo "NDK = $NDK"
          test -d "$NDK" || (echo "NDK path invalid" && exit 1)

          API=21
          TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64"
          SYSROOT="$TOOLCHAIN/sysroot"

          rm -rf out
          mkdir -p out

          build_one() {
            ABI="$1"
            CPU="$2"
            ARCH="$3"
            CC="$4"
            CXX="$5"

            PREFIX="$PWD/out/$ABI"
            mkdir -p "$PREFIX"

            echo "==== Building FFmpeg for $ABI ===="

            # Only distclean if Makefile exists
            if [ -f Makefile ]; then
              make distclean || true
            fi

            ./configure \
              --prefix="$PREFIX" \
              --target-os=android \
              --arch="$ARCH" \
              --cpu="$CPU" \
              --enable-cross-compile \
              --sysroot="$SYSROOT" \
              --cc="$CC" \
              --cxx="$CXX" \
              --ar="$TOOLCHAIN/bin/llvm-ar" \
              --ranlib="$TOOLCHAIN/bin/llvm-ranlib" \
              --strip="$TOOLCHAIN/bin/llvm-strip" \
              --disable-shared --enable-static \
              --enable-pic \
              --disable-doc --disable-programs \
              --enable-gpl --enable-version3 \
              --enable-protocol=http,https,tcp,udp,file,pipe,crypto \
              --enable-demuxer=hls,mpegts,matroska,mov,avi \
              --enable-decoder=h264,hevc,aac,mp3,ac3,eac3,opus,flac \
              --enable-decoder=dvbsub,hdmv_pgs_subtitle,ass,subrip,mov_text,eia_608,eia_708 \
              --extra-cflags="-fPIC" \
              --extra-ldflags=""

            make -j"$(nproc)"
            make install
          }

          # arm64-v8a
          build_one "arm64-v8a" "armv8-a" "aarch64" \
            "$TOOLCHAIN/bin/aarch64-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/aarch64-linux-android${API}-clang++"

          # armeabi-v7a
          build_one "armeabi-v7a" "armv7-a" "arm" \
            "$TOOLCHAIN/bin/armv7a-linux-androideabi${API}-clang" \
            "$TOOLCHAIN/bin/armv7a-linux-androideabi${API}-clang++"

          # x86_64
          build_one "x86_64" "x86-64" "x86_64" \
            "$TOOLCHAIN/bin/x86_64-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/x86_64-linux-android${API}-clang++"

          # x86
          build_one "x86" "i686" "x86" \
            "$TOOLCHAIN/bin/i686-linux-android${API}-clang" \
            "$TOOLCHAIN/bin/i686-linux-android${API}-clang++"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-android
          path: ffmpeg/out
